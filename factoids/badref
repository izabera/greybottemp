Be careful when using functions that use namerefs (typeset -n): https://gist.github.com/ormaaj/5682807